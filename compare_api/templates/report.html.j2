<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>API Comparison Report</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', Arial, sans-serif; margin: 24px; }
    .summary { display: flex; gap: 16px; margin-bottom: 24px; }
    .card { padding: 12px 16px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fafafa; }
    .ok { color: #0a7f27; }
    .bad { color: #b91c1c; }
    .case { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 16px; }
    .case-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-bottom: 1px solid #e5e7eb; }
    .case-body { padding: 12px 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    pre { background: #0b1021; color: #e5e7eb; padding: 12px; border-radius: 6px; overflow: auto; font-size: 12px; line-height: 1.4; }
    code { white-space: pre-wrap; word-break: break-all; }
    pre code { font-family: 'Courier New', Courier, monospace; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; }
    .tag { padding: 2px 6px; border-radius: 999px; font-size: 12px; border: 1px solid #e5e7eb; }
    .pass { background: #ecfdf5; color: #065f46; }
    .fail { background: #fef2f2; color: #7f1d1d; }
    details > summary { cursor: pointer; }

    /* Targets header styling */
    .targets { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; margin: 12px 0 18px; }
    .target-card { position: relative; border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px 16px; background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%); box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .target-label { font-size: 12px; color: #6b7280; display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
    .dot { display: inline-block; width: 8px; height: 8px; border-radius: 999px; }
    .dot-left { background: #2563eb; }
    .dot-right { background: #7c3aed; }
    .target-name { font-weight: 600; font-size: 14px; color: #111827; }
    .target-url { margin-top: 4px; display: inline-block; background: #111827; color: #e5e7eb; border-radius: 6px; padding: 4px 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .targets-title { font-weight: 600; color: #111827; margin-bottom: 6px; }
    .header-actions { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .btn { border: 1px solid #e5e7eb; background: #fff; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
    .btn:hover { background: #f9fafb; }

    /* New styles for path group summary and sub-cases */
    .path-group-summary {
      background: #f0f9eb; /* Light green background */
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
    }
    .sub-cases-summary {
      display: flex;
      gap: 12px;
      font-size: 14px;
      color: #374151;
    }
    .sub-case-count, .sub-case-passed, .sub-case-failed {
      font-weight: 600;
    }
    .sub-case {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: #f9fafb;
    }
    .sub-case-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    .sub-case-body {
      padding-top: 8px;
    }
    .sub-case-status {
      font-size: 14px;
      color: #374151;
      margin-bottom: 8px;
    }
    .diff-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .diff-item {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #374151;
    }
    .diff-table {
      width: 100%;
      font-size: 12px;
    }
    .diff-table th, .diff-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }

    /* Comparison layout styles */
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 12px;
    }
    .left-column, .right-column {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      background: #fafafa;
    }
    .left-column {
      border-left-color: #2563eb;
      border-left-width: 4px;
    }
    .right-column {
      border-left-color: #7c3aed;
      border-left-width: 4px;
    }
    .left-column h4, .left-column h5 {
      color: #2563eb;
      margin-top: 0;
    }
    .right-column h4, .right-column h5 {
      color: #7c3aed;
      margin-top: 0;
    }
    .response-details {
      margin-top: 12px;
    }
    .status-info {
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 14px;
      color: #374151;
    }
    .response-body {
      margin-top: 12px;
    }
    .response-body h5, .response-body h6 {
      margin-top: 0;
      margin-bottom: 8px;
      color: #111827;
    }
    .diff-body pre {
      background: #0b1021;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 6px;
      overflow: auto;
      font-size: 12px;
    }
    .diff-body code {
      white-space: pre-wrap;
    }
    .query-params {
      font-size: 12px;
      color: #6b7280;
      margin-left: 8px;
    }
  </style>
  <script>
    function toggleAll(open) {
      document.querySelectorAll('details').forEach(d => d.open = open);
    }
  </script>
  </head>
<body>
  <h2>API Comparison Report</h2>
  {% if targets %}
  <div class="targets">
    <div class="target-card">
      <div class="target-label"><span class="dot dot-left"></span> Left</div>
      <div class="target-name">{{ targets.left.name }}</div>
      <span class="target-url">{{ targets.left.base_url }}</span>
    </div>
    <div class="target-card">
      <div class="target-label"><span class="dot dot-right"></span> Right</div>
      <div class="target-name">{{ targets.right.name }}</div>
      <span class="target-url">{{ targets.right.base_url }}</span>
    </div>
  </div>
  {% endif %}
  <div class="summary">
    <div class="card"><strong>Total</strong><div>{{ summary.total }}</div></div>
    <div class="card ok"><strong>Passed</strong><div>{{ summary.passed }}</div></div>
    <div class="card bad"><strong>Failed</strong><div>{{ summary.failed }}</div></div>
    <div class="header-actions">
      <button class="btn" onclick="toggleAll(true)">Expand all</button>
      <button class="btn" onclick="toggleAll(false)">Collapse all</button>
    </div>
  </div>

  {% for r in results %}
  <div class="case">
    <div class="case-header">
      <div>
        <span class="tag {{ 'pass' if r.compare.equal else 'fail' }}">{{ 'PASS' if r.compare.equal else 'FAIL' }}</span>
        <strong>#{{ r.id }} {{ r.request.method }} {{ r.request.path }}</strong>
        {% if r.type == 'path_group' %}
          <span class="path-group-info">(Path Group: {{ r.summary.total_sub_cases }} parameter combinations)</span>
        {% endif %}
      </div>
      <div>
        {% if r.type == 'path_group' %}
          Sub-cases: {{ r.summary.passed_sub_cases }}/{{ r.summary.total_sub_cases }} passed
        {% else %}
          Status: {{ r.left.status }} vs {{ r.right.status }} | Time: {{ r.left.elapsed_ms }}ms vs {{ r.right.elapsed_ms }}ms
        {% endif %}
      </div>
    </div>
    <div class="case-body">
      {% if r.error %}
        <div class="bad">Error: {{ r.error }}</div>
      {% endif %}

      {% if r.type != 'path_group' %}
      <!-- Request Details for single test case -->
      <details>
        <summary>Request Details</summary>
        <div>
          <h4>Request Parameters</h4>
          <pre><code>{{ r.request.query | tojson(indent=2) }}</code></pre>
          <h4>Request Headers</h4>
          <pre><code>{{ r.request.headers | tojson(indent=2) }}</code></pre>
          {% if r.request.body %}
          <h4>Request Body</h4>
          <pre><code>{{ r.request.body | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</code></pre>
          {% endif %}
        </div>
      </details>
      {% endif %}

      {% if r.type == 'path_group' %}
        <!-- Path Group Summary -->
        <div class="path-group-summary">
          <h4>Path Group Summary</h4>
          <div class="sub-cases-summary">
            <span class="sub-case-count">Total Parameter Combinations: {{ r.summary.total_sub_cases }}</span>
            <span class="sub-case-passed">Passed: {{ r.summary.passed_sub_cases }}</span>
            <span class="sub-case-failed">Failed: {{ r.summary.failed_sub_cases }}</span>
          </div>
        </div>

        <!-- Sub-cases for parameter combinations -->
        <details open>
          <summary>Parameter Combination Details</summary>
          {% for sub_case in r.sub_cases %}
            <div class="sub-case">
              <div class="sub-case-header">
                <span class="tag {{ 'pass' if sub_case.compare.equal else 'fail' }}">{{ 'PASS' if sub_case.compare.equal else 'FAIL' }}</span>
                <strong>{{ sub_case.id }}: {{ sub_case.request.method }} {{ sub_case.request.path }}</strong>
                {% if sub_case.request.query %}
                  <span class="query-params">with params: {{ sub_case.request.query | tojson }}</span>
                {% endif %}
              </div>
                                            <div class="sub-case-body">
                <div class="sub-case-status">
                  Status: {{ sub_case.left.status }} vs {{ sub_case.right.status }} | 
                  Time: {{ sub_case.left.elapsed_ms }}ms vs {{ sub_case.right.elapsed_ms }}ms
                </div>
                
                <!-- Request Details for this sub-case -->
                <details>
                  <summary>Request Details</summary>
                  <div>
                    <h6>Request Parameters</h6>
                    <pre><code>{{ sub_case.request.query | tojson(indent=2) }}</code></pre>
                    <h6>Request Headers</h6>
                    <pre><code>{{ sub_case.request.headers | tojson(indent=2) }}</code></pre>
                    {% if sub_case.request.body %}
                    <h6>Request Body</h6>
                    <pre><code>{{ sub_case.request.body | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</code></pre>
                    {% endif %}
                  </div>
                </details>

                <!-- Response Comparison -->
                  <details open>
                    <summary>Response Comparison (Left vs Right)</summary>
                    <div class="comparison-grid">
                      <div class="left-column">
                        <h5>Left ({{ sub_case.left.target }})</h5>
                        <div class="response-details">
                          <div class="status-info">
                            <strong>Status:</strong> {{ sub_case.left.status }} | 
                            <strong>Time:</strong> {{ sub_case.left.elapsed_ms }}ms
                          </div>
                          <div class="response-body">
                            <h6>Response Body:</h6>
                            <pre><code>{% if sub_case.left.body_text %}{{ sub_case.left.body_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}{% elif sub_case.left.body_json %}{{ sub_case.left.body_json | tojson(indent=2) }}{% else %}No response body{% endif %}</code></pre>
                          </div>
                        </div>
                      </div>
                      <div class="right-column">
                        <h5>Right ({{ sub_case.right.target }})</h5>
                        <div class="response-details">
                          <div class="status-info">
                            <strong>Status:</strong> {{ sub_case.right.status }} | 
                            <strong>Time:</strong> {{ sub_case.right.elapsed_ms }}ms
                          </div>
                          <div class="response-body">
                            <h6>Response Body:</h6>
                            <pre><code>{% if sub_case.right.body_text %}{{ sub_case.right.body_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}{% elif sub_case.right.body_json %}{{ sub_case.right.body_json | tojson(indent=2) }}{% else %}No response body{% endif %}</code></pre>
                          </div>
                        </div>
                      </div>
                    </div>
                  </details>
                  
                  {% if not sub_case.compare.equal %}
                    <details>
                      <summary>Differences</summary>
                    {% if not sub_case.compare.status.equal %}
                      <div class="diff-section">
                        <h5>Status Difference</h5>
                        <div class="diff-item">
                          <span class="left">Left: {{ sub_case.left.status }}</span>
                          <span class="right">Right: {{ sub_case.right.status }}</span>
                        </div>
                      </div>
                    {% endif %}
                    
                    {% if not sub_case.compare.headers.equal %}
                      <div class="diff-section">
                        <h5>Header Differences</h5>
                        <table class="diff-table">
                          <tr><th>Header</th><th>Left</th><th>Right</th></tr>
                          {% for d in sub_case.compare.headers.diffs %}
                            <tr><td>{{ d.key }}</td><td>{{ d.left }}</td><td>{{ d.right }}</td></tr>
                          {% endfor %}
                        </table>
                      </div>
                    {% endif %}
                    
                    {% if not sub_case.compare.bodies.equal %}
                      <div class="diff-section">
                        <h5>Body Differences</h5>
                        {% if sub_case.compare.bodies.mode == 'json' %}
                          <pre class="diff-body"><code>{{ sub_case.compare.bodies.diff | tojson(indent=2) }}</code></pre>
                        {% elif sub_case.compare.bodies.mode == 'xml' %}
                          <div class="diff-body">
                            <h6>XML responses normalized for comparison</h6>
                            <div class="left">Left: {{ sub_case.compare.bodies.left_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</div>
                            <div class="right">Right: {{ sub_case.compare.bodies.right_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</div>
                          </div>
                        {% else %}
                          <div class="diff-body">
                            <div class="left">Left: {{ sub_case.compare.bodies.left_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</div>
                            <div class="right">Right: {{ sub_case.compare.bodies.right_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</div>
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </details>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </details>
      {% endif %}
      {% if r.type != 'path_group' %}
      <!-- Response Comparison -->
      <details open>
        <summary>Response Comparison (Left vs Right)</summary>
        <div class="comparison-grid">
          <div class="left-column">
            <h4>Left ({{ r.left.target }})</h4>
            <div class="response-details">
              <div class="status-info">
                <strong>Status:</strong> {{ r.left.status }} | 
                <strong>Time:</strong> {{ r.left.elapsed_ms }}ms
              </div>
              <div class="response-body">
                <h5>Response Body:</h5>
                <pre><code>{% if r.left.body_text %}{{ r.left.body_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}{% elif r.left.body_json %}{{ r.left.body_json | tojson(indent=2) }}{% else %}No response body{% endif %}</code></pre>
              </div>
            </div>
          </div>
          <div class="right-column">
            <h4>Right ({{ r.right.target }})</h4>
            <div class="response-details">
              <div class="status-info">
                <strong>Status:</strong> {{ r.right.status }} | 
                <strong>Time:</strong> {{ r.right.elapsed_ms }}ms
              </div>
              <div class="response-body">
                <h5>Response Body:</h5>
                <pre><code>{% if r.right.body_text %}{{ r.right.body_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}{% elif r.right.body_json %}{{ r.right.body_json | tojson(indent=2) }}{% else %}No response body{% endif %}</code></pre>
              </div>
            </div>
          </div>
        </div>
      </details>
      {% endif %}

      {% if r.type != 'path_group' %}
      <details open>
        <summary>Headers Diff (ignored headers already filtered)</summary>
        {% if r.compare.headers.equal %}
          <div class="ok">Headers are equal</div>
        {% else %}
          <table>
            <tr><th>Header</th><th>Left</th><th>Right</th></tr>
            {% for d in r.compare.headers.diffs %}
              <tr><td>{{ d.key }}</td><td>{{ d.left }}</td><td>{{ d.right }}</td></tr>
            {% endfor %}
          </table>
        {% endif %}
      </details>

      <details open>
        <summary>Body Diff</summary>
                  {% if r.compare.bodies.mode == 'json' %}
            {% if r.compare.bodies.equal %}
              <div class="ok">Bodies are equal</div>
            {% else %}
              <h4>Diff</h4>
              <pre><code>{{ r.compare.bodies.diff | tojson(indent=2) }}</code></pre>
            {% endif %}
            <div class="grid">
              <div>
                <h4>Left</h4>
                <pre><code>{{ r.compare.bodies.left_pretty | safe }}</code></pre>
              </div>
              <div>
                <h4>Right</h4>
                <pre><code>{{ r.compare.bodies.right_pretty | safe }}</code></pre>
              </div>
            </div>
          {% elif r.compare.bodies.mode == 'xml' %}
            {% if r.compare.bodies.equal %}
              <div class="ok">XML bodies are functionally equal (normalized for comparison)</div>
            {% else %}
              <h4>XML Comparison (normalized)</h4>
              <div class="grid">
                <div>
                  <h4>Left</h4>
                  <pre><code>{{ r.compare.bodies.left_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</code></pre>
                </div>
                <div>
                  <h4>Right</h4>
                  <pre><code>{{ r.compare.bodies.right_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</code></pre>
                </div>
              </div>
            {% endif %}
          {% else %}
            {% if r.compare.bodies.equal %}
              <div class="ok">Bodies are equal</div>
            {% else %}
              <div class="grid">
                <div>
                  <h4>Left</h4>
                  <pre><code>{{ r.compare.bodies.left_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</code></pre>
                </div>
                <div>
                  <h4>Right</h4>
                  <pre><code>{{ r.compare.bodies.right_text | format_xml | replace('&', '&amp;') | replace('<', '&lt;') | replace('>', '&gt;') | replace('"', '&quot;') | replace("'", '&#39;') }}</code></pre>
                </div>
              </div>
            {% endif %}
          {% endif %}
      </details>
      {% endif %}
    </div>
  </div>
  {% endfor %}

</body>
</html>

